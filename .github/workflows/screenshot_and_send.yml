name: Screenshot and Send to WeChat

on:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´10ç‚¹æ‰§è¡Œ
  workflow_dispatch:
    inputs:
      urls:
        description: 'è¦æˆªå›¾çš„URLåˆ—è¡¨ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰'
        required: false
        default: ''
        type: string
      verbose:
        description: 'å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡º'
        required: false
        default: false
        type: boolean

jobs:
  screenshot_and_send:
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 10
    permissions:
      contents: write
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN || secrets.PAT }}
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium --with-deps
          
      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
      - name: Build command arguments
        id: build_args
        run: |
          ARGS=""
          
          # å¤„ç†URLå‚æ•°
          if [ -n "${{ github.event.inputs.urls }}" ]; then
            ARGS="$ARGS --urls ${{ github.event.inputs.urls }}"
          fi
          
          # å¤„ç†è¯¦ç»†æ—¥å¿—å‚æ•°
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            ARGS="$ARGS --verbose"
          fi
          
          # è®¾ç½®CIçŽ¯å¢ƒå˜é‡
          echo "CI=true" >> $GITHUB_ENV
          echo "DEBUG_LOCAL=false" >> $GITHUB_ENV
          
          echo "args=$ARGS" >> $GITHUB_OUTPUT
          
      - name: Run screenshot and send script
        id: screenshot_script
        env:
          WEBHOOK_KEY: ${{ secrets.WEBHOOK_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          CI: true
          DEBUG_LOCAL: false
        run: |
          python screenshot_and_send.py ${{ steps.build_args.outputs.args }}
        continue-on-error: true
        
      - name: Check script execution result
        if: steps.screenshot_script.outcome == 'failure'
        run: |
          echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥"
          echo "æ£€æŸ¥æ—¥å¿—ä»¥èŽ·å–è¯¦ç»†ä¿¡æ¯"
          exit 1
          
      - name: Commit and push changes (cleanup)
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add -A screenshots/
          if git diff --staged --quiet; then
            echo "ðŸ“ æ²¡æœ‰éœ€è¦æäº¤çš„æˆªå›¾æ–‡ä»¶"
          else
            git commit -m "chore: cleanup screenshots after sending $(date '+%Y-%m-%d %H:%M:%S')"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git main
            echo "ðŸ“ å·²æ¸…ç†æˆªå›¾æ–‡ä»¶"
          fi
          
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“‹ ä»»åŠ¡æ‰§è¡Œæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡ŒçŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.screenshot_script.outcome }}" = "success" ]; then
            echo "- âœ… **æˆªå›¾ä»»åŠ¡**: æˆåŠŸå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **æˆªå›¾ä»»åŠ¡**: æ‰§è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
