name: Screenshot and Send to WeChat

on:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´10ç‚¹æ‰§è¡Œ
  workflow_dispatch:
    inputs:
      urls:
        description: 'è¦æˆªå›¾çš„URLåˆ—è¡¨ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰'
        required: false
        default: ''
        type: string
      verbose:
        description: 'å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡º'
        required: false
        default: false
        type: boolean
      update-playwright:
        description: 'å¼ºåˆ¶æ›´æ–°PlaywrightäºŒè¿›åˆ¶æ–‡ä»¶'
        required: false
        default: false
        type: boolean

jobs:
  screenshot_and_send:
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 15
    permissions:
      contents: write
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN || secrets.PAT }}
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
          
      - name: Install dependencies
        run: |
          # å®‰è£…ä¾èµ–åŒ…ï¼ŒåŒ…å«æ‰€æœ‰ä¾èµ–å…³ç³»
          pip install -r requirements.txt --progress-bar off
          
      - name: Check Playwright binary updates
        id: check_updates
        run: |
          echo "ðŸ” æ£€æŸ¥PlaywrightäºŒè¿›åˆ¶æ–‡ä»¶æ›´æ–°..."
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶æ›´æ–°
          if [ "${{ github.event.inputs.update-playwright }}" = "true" ]; then
            echo "ðŸ“¥ å¼ºåˆ¶æ›´æ–°æ¨¡å¼ï¼šä¸‹è½½æœ€æ–°PlaywrightäºŒè¿›åˆ¶æ–‡ä»¶"
            echo "UPDATE_NEEDED=true" >> $GITHUB_OUTPUT
          else
            # ä½¿ç”¨Pythonè„šæœ¬æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶
            UPDATE_CHECK=$(python check_playwright.py)
            echo "$UPDATE_CHECK"
            echo "$UPDATE_CHECK" >> $GITHUB_OUTPUT
          fi
          
      - name: Download and update Playwright binaries
        if: steps.check_updates.outputs.UPDATE_NEEDED == 'true'
        run: |
          echo "ðŸ“¥ ä¸‹è½½æœ€æ–°PlaywrightäºŒè¿›åˆ¶æ–‡ä»¶..."
          
          # æ¸…ç†æ—§çš„äºŒè¿›åˆ¶æ–‡ä»¶
          rm -rf playwright-binaries
          mkdir -p playwright-binaries
          
          # ä¸‹è½½Playwrightæµè§ˆå™¨åˆ°ä¸´æ—¶ç›®å½•
          PLAYWRIGHT_BROWSERS_PATH=/tmp/playwright-temp playwright install chromium --with-deps
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•ï¼ˆåªå¤åˆ¶å¿…è¦çš„æ–‡ä»¶ï¼‰
          cp -r /tmp/playwright-temp/* playwright-binaries/
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          find playwright-binaries/ -name "headless_shell" -exec chmod +x {} \;
          find playwright-binaries/ -name "chrome" -exec chmod +x {} \;
          
          # åˆ—å‡ºäºŒè¿›åˆ¶æ–‡ä»¶å†…å®¹
          echo "ðŸ“‹ å·²ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶:"
          ls -la playwright-binaries/
          find playwright-binaries/ -type f -name "*.so" -o -name "headless_shell" -o -name "chrome" | head -10
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/playwright-temp
          
      - name: Setup Playwright from local binaries
        run: |
          echo "ðŸŽ¯ ä»Žæœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶è®¾ç½®Playwright..."
          
          # åˆ›å»ºç³»ç»Ÿç¼“å­˜ç›®å½•
          mkdir -p ~/.cache/ms-playwright/
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶åˆ°ç³»ç»Ÿç›®å½•
          if [ -d "playwright-binaries" ]; then
            cp -r playwright-binaries/* ~/.cache/ms-playwright/
            echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶å®Œæˆ"
          else
            echo "âŒ äºŒè¿›åˆ¶æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # ç¡®ä¿æ‰§è¡Œæƒé™
          find ~/.cache/ms-playwright/ -name "headless_shell" -exec chmod +x {} \;
          find ~/.cache/ms-playwright/ -name "chrome" -exec chmod +x {} \;
          
          # éªŒè¯Playwrightå®‰è£…
          echo "ðŸ” éªŒè¯Playwrightå®‰è£…..."
          python check_playwright.py verify
          
      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
      - name: Build command arguments
        id: build_args
        run: |
          ARGS=""
          
          # å¤„ç†URLå‚æ•°
          if [ -n "${{ github.event.inputs.urls }}" ]; then
            ARGS="$ARGS --urls ${{ github.event.inputs.urls }}"
          fi
          
          # å¤„ç†è¯¦ç»†æ—¥å¿—å‚æ•°
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            ARGS="$ARGS --verbose"
          fi
          
          # è®¾ç½®CIçŽ¯å¢ƒå˜é‡
          echo "CI=true" >> $GITHUB_ENV
          echo "DEBUG_LOCAL=false" >> $GITHUB_ENV
          
          echo "args=$ARGS" >> $GITHUB_OUTPUT
          
      - name: Run screenshot and send script
        id: screenshot_script
        env:
          WEBHOOK_KEY: ${{ secrets.WEBHOOK_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          CI: true
          DEBUG_LOCAL: false
        run: |
          python screenshot_and_send.py ${{ steps.build_args.outputs.args }} --width 1920 --height 1080
        continue-on-error: true
        
      - name: Check script execution result
        if: steps.screenshot_script.outcome == 'failure'
        run: |
          echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥"
          echo "æ£€æŸ¥æ—¥å¿—ä»¥èŽ·å–è¯¦ç»†ä¿¡æ¯"
          exit 1
          
      - name: Commit and push Playwright binaries (with retry)
        if: steps.check_updates.outputs.UPDATE_NEEDED == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -d "playwright-binaries" ]; then
            git add -A playwright-binaries/
            if git diff --staged --quiet; then
              echo "ðŸŽ¯ PlaywrightäºŒè¿›åˆ¶æ–‡ä»¶æ— å˜åŒ–"
            else
              echo "ðŸ“¤ å°è¯•æäº¤PlaywrightäºŒè¿›åˆ¶æ–‡ä»¶..."
              git commit -m "chore: update playwright binaries $(date '+%Y-%m-%d %H:%M:%S')"
              
              # è®¡ç®—æ–‡ä»¶å¤§å°
              TOTAL_SIZE=$(du -sk playwright-binaries/ | cut -f1)
              echo "ðŸ“Š äºŒè¿›åˆ¶æ–‡ä»¶æ€»å¤§å°: ${TOTAL_SIZE}KB"
              
              # å°è¯•æŽ¨é€ï¼Œè®¾ç½®æ›´é•¿çš„è¶…æ—¶æ—¶é—´
              echo "ðŸ“¤ å°è¯•æŽ¨é€äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆç¬¬ä¸€æ¬¡å°è¯•ï¼‰..."
              if git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git main --timeout=600; then
                echo "âœ… PlaywrightäºŒè¿›åˆ¶æ–‡ä»¶å·²æˆåŠŸæŽ¨é€åˆ°ä»“åº“"
              else
                echo "âš ï¸ ç¬¬ä¸€æ¬¡æŽ¨é€å¤±è´¥ï¼Œå°è¯•æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶..."
                
                # æ¸…ç†ä¸€äº›ä¸å¿…è¦çš„æ–‡ä»¶ä»¥å‡å°‘å¤§å°
                find playwright-binaries/ -name "*.pdb" -delete
                find playwright-binaries/ -name "*.debug" -delete
                find playwright-binaries/ -name "*.map" -delete
                
                # é‡æ–°æäº¤
                git add -A playwright-binaries/
                git commit -m "chore: update playwright binaries (optimized) $(date '+%Y-%m-%d %H:%M:%S')"
                
                echo "ðŸ“¤ å°è¯•æŽ¨é€ä¼˜åŒ–åŽçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆç¬¬äºŒæ¬¡å°è¯•ï¼‰..."
                if git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git main --timeout=600; then
                  echo "âœ… PlaywrightäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä¼˜åŒ–ç‰ˆï¼‰å·²æˆåŠŸæŽ¨é€åˆ°ä»“åº“"
                else
                  echo "âŒ æŽ¨é€å¤±è´¥ï¼Œä½†CIä»»åŠ¡ç»§ç»­æ‰§è¡Œ"
                  echo "ðŸ’¡ å»ºè®®ï¼šæ‰‹åŠ¨æ¸…ç†ä»“åº“ä¸­çš„å¤§æ–‡ä»¶æˆ–ä½¿ç”¨Git LFS"
                fi
              fi
            fi
          fi
          
      - name: Commit and push changes (cleanup)
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add -A screenshots/
          if git diff --staged --quiet; then
            echo "ðŸ“ æ²¡æœ‰éœ€è¦æäº¤çš„æˆªå›¾æ–‡ä»¶"
          else
            git commit -m "chore: cleanup screenshots after sending $(date '+%Y-%m-%d %H:%M:%S')"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git main
            echo "ðŸ“ å·²æ¸…ç†æˆªå›¾æ–‡ä»¶"
          fi
          
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“‹ ä»»åŠ¡æ‰§è¡Œæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡ŒçŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PlaywrightäºŒè¿›åˆ¶æ›´æ–°**: ${{ steps.check_updates.outputs.UPDATE_NEEDED }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.screenshot_script.outcome }}" = "success" ]; then
            echo "- âœ… **æˆªå›¾ä»»åŠ¡**: æˆåŠŸå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **æˆªå›¾ä»»åŠ¡**: æ‰§è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
