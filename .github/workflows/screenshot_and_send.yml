name: Screenshot and Send to WeChat

on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´16ç‚¹æ‰§è¡Œ
  workflow_dispatch:
    inputs:
      urls:
        description: 'è¦æˆªå›¾çš„URLåˆ—è¡¨ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰'
        required: false
        default: ''
        type: string
      verbose:
        description: 'å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡º'
        required: false
        default: false
        type: boolean

jobs:
  screenshot_and_send:
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 20
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN || secrets.PAT }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç¼“å­˜ pip ä¾èµ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache pip dependencies
        uses: actions/cache@v4
        id: pip-cache
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è®¾ç½® Python â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç¼“å­˜ Playwright æµè§ˆå™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å®‰è£…ä¾èµ–å’Œ Playwright â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        run: |
          # å‡çº§ pip å¹¶å®‰è£…é¡¹ç›®ä¾èµ–
          python -m pip install --upgrade pip
          pip install -r requirements.txt --progress-bar off

          # å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆplaywright install-deps å¾ˆå¿«ï¼Œé€šå¸¸å‡ ç§’ï¼‰
          playwright install-deps

          # åªæœ‰å½“ Playwright æµè§ˆå™¨ç¼“å­˜æœªå‘½ä¸­æ—¶æ‰å®‰è£…æµè§ˆå™¨
          if [ "${{ steps.playwright-cache.outputs.cache-hit }}" != "true" ]; then
            echo "Playwright browsers cache miss â†’ installing browsers..."
            playwright install chromium --with-deps
          else
            echo "Playwright browsers restored from cache â†’ skipping installation"
          fi

      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Build command arguments
        id: build_args
        run: |
          ARGS=""

          # å¤„ç†URLå‚æ•°
          if [ -n "${{ github.event.inputs.urls }}" ]; then
            ARGS="$ARGS --urls ${{ github.event.inputs.urls }}"
          fi

          # å¤„ç†è¯¦ç»†æ—¥å¿—å‚æ•°
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            ARGS="$ARGS --verbose"
          fi

          # è®¾ç½®CIçŽ¯å¢ƒå˜é‡
          echo "CI=true" >> $GITHUB_ENV
          echo "DEBUG_LOCAL=false" >> $GITHUB_ENV

          echo "args=$ARGS" >> $GITHUB_OUTPUT

      - name: Run screenshot and send script
        id: screenshot_script
        env:
          WEBHOOK_KEY: ${{ secrets.WEBHOOK_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          CI: true
          DEBUG_LOCAL: false
        run: |
          python screenshot_and_send.py ${{ steps.build_args.outputs.args }} --width 1920 --height 1080
        continue-on-error: true

      - name: Check script execution result
        if: steps.screenshot_script.outcome == 'failure'
        run: |
          echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥"
          echo "æ£€æŸ¥æ—¥å¿—ä»¥èŽ·å–è¯¦ç»†ä¿¡æ¯"
          exit 1

      - name: Commit and push screenshots
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add -A screenshots/
          git commit -m "feat: update screenshots $(date '+%Y-%m-%d %H:%M:%S')" --allow-empty
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git ${{ github.ref_name }}
          echo "ðŸ“ æˆªå›¾æ–‡ä»¶å·²å¼ºåˆ¶æäº¤åˆ°ä»“åº“"

      - name: Send webhook message
        if: success() && steps.screenshot_script.outcome == 'success'
        env:
          WEBHOOK_KEY: ${{ secrets.WEBHOOK_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          CI: true
        run: |
          echo "ðŸ“¤ å‘é€ä¼ä¸šå¾®ä¿¡webhookæ¶ˆæ¯..."
          python -c "
          import sys
          sys.path.append('.')
          from screenshot_and_send import send_webhook_from_file, get_env_config
          config = get_env_config()
          success = send_webhook_from_file(config, 'image_urls.txt')
          sys.exit(0 if success else 1)
          "

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“‹ ä»»åŠ¡æ‰§è¡Œæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡ŒçŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.screenshot_script.outcome }}" = "success" ]; then
            echo "- âœ… **æˆªå›¾ä»»åŠ¡**: æˆåŠŸå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **æˆªå›¾ä»»åŠ¡**: æ‰§è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.send_webhook_message.outcome }}" = "success" ]; then
            echo "- âœ… **Webhookå‘é€**: æˆåŠŸå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.send_webhook_message.outcome }}" = "failure" ]; then
            echo "- âŒ **Webhookå‘é€**: æ‰§è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ **Webhookå‘é€**: æœªæ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY
          fi
